#!/usr/bin/perl
#jackg@uic.edu 
#
#
# swcdpPhoneMoves.pl - reads swcdpPhoneMoves.out and sends info to VoIP people
#

use strict;

use FindBin qw($Bin);
use lib "$FindBin::Bin/../lib";
my $installpath = $Bin;
$installpath =~ s/\/$//;
$installpath =~ s/\/bin//;

use IO::File;

use DBI;
require "$installpath/lib/dbipw.pl";
my ($h,$u,$p) = dbigrabit();
my $dbh = DBI->connect("DBI:mysql:host=$h",$u,$p,{RaiseError => 1});

my $inf   = "$installpath/data/swcdpPhoneMoves.out";
my $infh  = IO::File->new("$inf");

my $mail_lines;
while ( my $ln = <$infh> )   {
   chomp($ln);
   #print "$ln\n";
   ##  2021-02-10 11:28:04 SEP002699437E4B none none none 10.100.34.72 ssb-fdf-i3 FastEthernet0/6
   my(undef,$date,$time,$phone,$previp,$prevname,$prevport,$currswip,$currswname,$currport) = split " ", $ln; 
   if ($date !~ /\d{4}\-\d{2}\-\d{2}/)  {
      print "Date: >$date<\n";
      print "Bad Entry skipped:  >$ln<\n";
      next;
   }
   ## tstamp phone previp prevname prevport currip currname currport 
   if ($previp eq "none")  {
      push @$mail_lines, "phone $phone has been installed to $currswname port $currport";
   }
   else  {
      push @$mail_lines, "phone $phone has moved from $prevname port $prevport to $currswname port $currport";
   }
   my $query = "INSERT INTO switch.phone_moves (tstamp,phone,previp,prevname,prevport,currip,currname,currport) VALUES(?,?,?,?,?,?,?,?)";
   my $insert_h = $dbh->prepare($query);
   $insert_h->execute("$date $time",$phone,$previp,$prevname,$prevport,$currswip,$currswname,$currport);
}

## TEST print:
foreach my $ml (@$mail_lines)  { print " >$ml<\n"; }
## Bail out of sendmail if there are no moved phones
if (scalar(@$mail_lines) == 0)  {
   print "No phone moves today\n";
   exit;
}

require "$installpath/lib/servers.pl";
my $user      = user();
my $admin     = admin();
my $voipadmin = voipadmin();
my $mailer    = scriptserver();
my $domain    = dnssuffix();
open (SENDMAIL, "|/usr/lib/sendmail -oi -t -odq") or die "Can't fork for sendmail: $!\n";
print SENDMAIL <<"EOF";
From: Mr. C. D. Peaugh <$user\@$mailer>
To: voipadmin <$voipadmin\@$domain>
Subject: VoIP phones: cdp port data - port change --> Phone Installs and Moves        

EOF

foreach my $ln (@$mail_lines)  {
  print SENDMAIL "$ln\n";
}

print SENDMAIL <<"EOF";


This script is at $mailer:  ./netwonk/bin/swcdpPhoneMoves.pl
It processes data generated by $mailer cron script instance:  ./netwonk/bin/swseeker.pl swcdp
This data is stored in table switch.phone_moves 

--
Yours in VoIP Portal Retentiveness,
Mr. C. D. Peaugh

EOF

close(SENDMAIL)  or warn "sendmail didn't close nicely";


###################################################

